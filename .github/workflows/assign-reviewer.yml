name: 무작위 리뷰어 할당

on:
  workflow_call: # 재사용 가능하도록 설정
    inputs:
      pr_title:
        required: true
        type: string
      pr_author:
        required: true
        type: string
      pr_link:
        required: true
        type: string

jobs:
  assign-reviewers:
    runs-on: ubuntu-latest

    steps:
      - name: Set up GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh

      - name: Select Random Reviewers
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          PR_TITLE="${{ inputs.pr_title }}"
          PR_AUTHOR="${{ inputs.pr_author }}"
          PR_LINK="${{ inputs.pr_link }}"

          # 리뷰어 및 디스코드 ID 매핑
          REVIEWERS=("gmvolt" "gmvolt2")
          declare -A DISCORD_IDS
          DISCORD_IDS["gmvolt"]="337576501216018442"
          DISCORD_IDS["gmvolt2"]="669355576731631635"
          
          # PR 작성자 제외
          FILTERED_REVIEWERS=()
          for reviewer in "${REVIEWERS[@]}"; do
            if [[ "$reviewer" != "$PR_AUTHOR" ]]; then
              FILTERED_REVIEWERS+=("$reviewer")
            fi
          done
          NUM_REVIEWERS=1
          SELECTED_REVIEWERS=($(shuf -e "${FILTERED_REVIEWERS[@]}" -n "$NUM_REVIEWERS"))
          
          echo "선택된 리뷰어: ${SELECTED_REVIEWERS[@]}"
          
          # 디스코드 메시지
          SELECTED_DISCORD_IDS=()
          for reviewer in "${SELECTED_REVIEWERS[@]}"; do
            SELECTED_DISCORD_IDS+=("${DISCORD_IDS[$reviewer]}")
          done
          DISCORD_MENTIONS=""
          for id in "${SELECTED_DISCORD_IDS[@]}"; do
            DISCORD_MENTIONS+="<@$id> "
          done
          MESSAGE="리뷰어로 지정되었습니다: ${DISCORD_MENTIONS}!\nPR 제목: $PR_TITLE\nPR 링크: $PR_LINK"
          
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"$MESSAGE\"}" \
               $WEBHOOK_URL
